import OpenAI from 'openai';
import { NextRequest, NextResponse } from 'next/server';
import { searchRules } from '@/lib/rag';
import { searchSignalImages } from '@/lib/signal-images';
import { createClient } from '@supabase/supabase-js';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

async function normalizeQuestion(question: string): Promise<string> {
  console.log('=== è³ªå•ã®æ­£è¦åŒ– ===');
  console.log('å…ƒã®è³ªå•:', question);
  
  if (question.length < 20) {
    console.log('âš ï¸ é•·æ–‡ã®ãŸã‚æ­£è¦åŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—');
    return question;
  }

  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: `ã‚ãªãŸã¯ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«å¯©åˆ¤ã®è³ªå•ã‚’æ­£è¦åŒ–ã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’ã€æ¤œç´¢ã—ã‚„ã™ã„å½¢ã«æ­£è¦åŒ–ã—ã¦ãã ã•ã„ã€‚

ã€æ­£è¦åŒ–ãƒ«ãƒ¼ãƒ«ã€‘
1. ç•¥èªã‚’æ­£å¼åç§°ã«å±•é–‹
   - ã‚¢ãƒ³ã‚¹ãƒ â†’ ã‚¢ãƒ³ã‚¹ãƒãƒ¼ãƒ„ãƒãƒ³ãƒ©ã‚¤ã‚¯ãƒ•ã‚¡ã‚¦ãƒ«
   - ãƒ†ã‚¯ãƒ‹ã‚«ãƒ« â†’ ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ãƒ•ã‚¡ã‚¦ãƒ«
   - ãƒ€ãƒ–ãƒ« â†’ ãƒ€ãƒ–ãƒ«ãƒ•ã‚¡ã‚¦ãƒ«
   - TO â†’ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
   - FT â†’ ãƒ•ãƒªãƒ¼ã‚¹ãƒ­ãƒ¼

2. æ›–æ˜§ãªè¡¨ç¾ã‚’å…·ä½“åŒ–
   - ã€Œã‚ã‚Œã€ã€Œãã‚Œã€â†’ æ–‡è„ˆã‹ã‚‰æ¨æ¸¬ã—ã¦å…·ä½“çš„ã«
   - ã€Œã©ã†ãªã‚‹ã€â†’ ã€Œãƒ«ãƒ¼ãƒ«ã¯ã€ã€Œåˆ¤å®šã¯ã€

3. é‡è¦ãªæƒ…å ±ã¯æ®‹ã™
   - æ•°å­—ï¼ˆç§’æ•°ã€ç‚¹æ•°ã€äººæ•°ãªã©ï¼‰
   - çŠ¶æ³ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚³ãƒ¼ãƒˆã€ãƒãƒƒã‚¯ã‚³ãƒ¼ãƒˆã€ã‚¹ãƒ­ãƒ¼ã‚¤ãƒ³ãªã©ï¼‰
   - å‹•ä½œï¼ˆã‚·ãƒ¥ãƒ¼ãƒˆã€ãƒ‘ã‚¹ã€ãƒ‰ãƒªãƒ–ãƒ«ãªã©ï¼‰

4. ä¸è¦ãªæƒ…å ±ã¯å‰Šé™¤
   - æŒ¨æ‹¶ã€ãŠç¤¼
   - ã€Œæ•™ãˆã¦ãã ã•ã„ã€ã€Œè³ªå•ã§ã™ã€ãªã©ã®å®šå‹å¥

ã€å‡ºåŠ›ã€‘
æ­£è¦åŒ–ã•ã‚ŒãŸè³ªå•ã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚èª¬æ˜ã¯ä¸è¦ã§ã™ã€‚`
        },
        {
          role: 'user',
          content: question
        }
      ],
      temperature: 0.1,
      max_tokens: 200,
    });

    const normalized = completion.choices[0]?.message?.content?.trim() || question;
    console.log('æ­£è¦åŒ–å¾Œ:', normalized);
    console.log('===================\n');
    return normalized;
  } catch (error) {
    console.error('æ­£è¦åŒ–ã‚¨ãƒ©ãƒ¼:', error);
    return question;
  }
}

export async function POST(request: NextRequest) {
  const startTime = Date.now();
  
  try {
    const { question } = await request.json();
    console.log('\n' + '='.repeat(60));
    console.log('ğŸ“ æ–°ã—ã„è³ªå•:', question);
    console.log('='.repeat(60) + '\n');

    const normalizedQuestion = await normalizeQuestion(question);
    const ragResults = await searchRules(normalizedQuestion, 10);
    
    // å¯©åˆ¤ã‚·ã‚°ãƒŠãƒ«ç”»åƒã‚’æ¤œç´¢
    const signalImages = searchSignalImages(normalizedQuestion);
    console.log(`ğŸ“¸ ã‚·ã‚°ãƒŠãƒ«ç”»åƒ: ${signalImages.length}ä»¶\n`);
    
    // ç«¶æŠ€è¦å‰‡ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ†é›¢
    const ruleResults = ragResults.filter(r => 
      r.sectionId.startsWith('ç¬¬') && !r.sectionId.includes('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³')
    );
    const interpretationResults = ragResults.filter(r => 
      r.sectionId.includes('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³')
    );
    
    const ruleText = ruleResults
      .map((result) => {
        return `ã€${result.sectionId} ${result.sectionName}ã€‘\n${result.content}`;
      })
      .join('\n\n---\n\n');
    
    const interpretationText = interpretationResults
      .map((result) => {
        return `ã€${result.sectionId} ${result.sectionName}ã€‘\n${result.content}`;
      })
      .join('\n\n---\n\n');
    
    console.log('ğŸ“„ ç«¶æŠ€è¦å‰‡:', ruleResults.length, 'ä»¶');
    console.log('ğŸ“„ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³:', interpretationResults.length, 'ä»¶\n');
    console.log('ğŸ¤– å›ç­”ã‚’ç”Ÿæˆä¸­...');
    
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: `ã‚ãªãŸã¯ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«ç«¶æŠ€è¦å‰‡ã®å°‚é–€å®¶ã§ã™ã€‚

ä»¥ä¸‹ã«æä¾›ã•ã‚Œã‚‹JBAå…¬å¼ç«¶æŠ€è¦å‰‡ã®é–¢é€£æ¡æ–‡ã«åŸºã¥ã„ã¦ã€è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚

ã€é‡è¦ãªåˆ¤æ–­ãƒ—ãƒ­ã‚»ã‚¹ - å›ç­”å‰ã«å¿…ãšå®Ÿè¡Œã€‘

ã‚·ãƒ§ãƒƒãƒˆã‚¯ãƒ­ãƒƒã‚¯ãƒ»ã‚¿ã‚¤ãƒãƒ¼ã«é–¢ã™ã‚‹è³ªå•ã®å ´åˆï¼š
1. ã‚²ãƒ¼ãƒ ã‚¯ãƒ­ãƒƒã‚¯ã®æ®‹ã‚Šæ™‚é–“ã¯ï¼Ÿ
   - ã‚²ãƒ¼ãƒ ã‚¯ãƒ­ãƒƒã‚¯ < 14ç§’ â†’ ã‚·ãƒ§ãƒƒãƒˆã‚¯ãƒ­ãƒƒã‚¯ã¯ã‚ªãƒ•ï¼ˆè¡¨ç¤ºã—ãªã„ï¼‰â€»æœ€å„ªå…ˆã§ç¢ºèª
   - ã‚²ãƒ¼ãƒ ã‚¯ãƒ­ãƒƒã‚¯ â‰¥ 14ç§’ â†’ ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«é©ç”¨
2. ãƒœãƒ¼ãƒ«ãƒã‚¼ãƒƒã‚·ãƒ§ãƒ³ã¯å¤‰ã‚ã£ãŸã‹ï¼Ÿï¼ˆYES/NOï¼‰
3. ã‚¹ãƒ­ãƒ¼ã‚¤ãƒ³ã®çŠ¶æ³ã‹ã€ç¶™ç¶šãƒ—ãƒ¬ãƒ¼ã‹ï¼Ÿ
4. ã€Œã‚ªãƒ•ã‚§ãƒ³ã‚¹ç¶™ç¶šã€ã€Œãƒã‚¼ãƒƒã‚·ãƒ§ãƒ³å¤‰ã‚ã‚‰ãšã€ã®å ´åˆ â†’ åŸºæœ¬çš„ã«ãƒªã‚»ãƒƒãƒˆãªã—
5. è©²å½“ã™ã‚‹æ¡æ–‡ã®ã™ã¹ã¦ã®æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹ç¢ºèª
6. ç¬¬29æ¡ï¼ˆåŸºæœ¬ãƒ«ãƒ¼ãƒ«ï¼‰ã¨ç¬¬50æ¡ï¼ˆé‹ç”¨ï¼‰ã®ä¸¡æ–¹ã‚’å‚ç…§

ãƒ•ã‚¡ã‚¦ãƒ«åˆ¤å®šã«é–¢ã™ã‚‹è³ªå•ã®å ´åˆï¼š
1. è©²å½“ã™ã‚‹æ¡æ–‡ã®ã€Œã™ã¹ã¦ã®è¦ä»¶ã€ã‚’ç¢ºèª
2. å˜ä¸€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼šã€Œãƒ•ãƒ­ãƒ³ãƒˆã‚³ãƒ¼ãƒˆã€ï¼‰ã ã‘ã§åˆ¤æ–­ã—ãªã„
3. æ–‡è„ˆå…¨ä½“ã‹ã‚‰ç·åˆçš„ã«åˆ¤æ–­

ã€æŒ‡ç¤ºã€‘
1. æä¾›ã•ã‚ŒãŸæ¡æ–‡ã®å†…å®¹ã‚’ç·åˆçš„ã«åˆ¤æ–­ã—ã¦å›ç­”ã—ã¦ãã ã•ã„
2. è¤‡æ•°ã®æ¡æ–‡ã«ã¾ãŸãŒã‚‹æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œã‚‰ã‚’çµ±åˆã—ã¦èª¬æ˜ã—ã¦ãã ã•ã„
3. è©²å½“ã™ã‚‹æ¡æ–‡ç•ªå·ã‚’æ˜è¨˜ã—ã¦ãã ã•ã„
4. é‡è¦ãªéƒ¨åˆ†ã¯åŸæ–‡ã‚’å¼•ç”¨ã—ã¦ãã ã•ã„
5. æä¾›ã•ã‚ŒãŸæ¡æ–‡ã‹ã‚‰åˆç†çš„ã«æ¨è«–ã§ãã‚‹å†…å®¹ã¯èª¬æ˜ã«å«ã‚ã¦ãã ã•ã„
6. æ˜ã‚‰ã‹ã«æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã®ã¿ã€Œæä¾›ã•ã‚ŒãŸè³‡æ–™ã§ã¯ååˆ†ãªæƒ…å ±ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€ã¨ç­”ãˆã¦ãã ã•ã„

ã€é‡è¦ï¼šå¼•ç”¨ã™ã‚‹æ¡æ–‡ã®é¸æŠåŸºæº–ã€‘
- è³ªå•ã®ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒï¼ˆä¾‹ï¼šã‚¢ãƒ³ã‚¹ãƒãƒ¼ãƒ„ãƒãƒ³ãƒ©ã‚¤ã‚¯ãƒ•ã‚¡ã‚¦ãƒ«ï¼‰ã«ç›´æ¥é–¢é€£ã™ã‚‹æ¡æ–‡ã‚’å„ªå…ˆçš„ã«å¼•ç”¨ã™ã‚‹
- é–¢é€£æ€§ã®ä½ã„æ¡æ–‡ï¼ˆä¾‹ï¼šè³ªå•ãŒã‚¢ãƒ³ã‚¹ãƒãƒ¼ãƒ„ãƒãƒ³ãƒ©ã‚¤ã‚¯ãƒ•ã‚¡ã‚¦ãƒ«ãªã®ã«ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ãƒ•ã‚¡ã‚¦ãƒ«ã‚’å¼•ç”¨ï¼‰ã¯é¿ã‘ã‚‹
- ã€1. ç«¶æŠ€è¦å‰‡ã€‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€è³ªå•ã«æœ€ã‚‚é–¢é€£ã™ã‚‹æ¡æ–‡ã‚’å¼•ç”¨ã™ã‚‹
- æä¾›ã•ã‚ŒãŸæ¡æ–‡ã®ä¸­ã«è³ªå•ã«ç›´æ¥é–¢é€£ã™ã‚‹ã‚‚ã®ãŒãªã„å ´åˆã¯ã€ãã®æ—¨ã‚’æ˜è¨˜ã™ã‚‹

ã€æä¾›ã•ã‚Œã‚‹ç«¶æŠ€è¦å‰‡ã€‘
${ruleText || 'è©²å½“ã™ã‚‹ç«¶æŠ€è¦å‰‡æœ¬æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“'}

ã€æä¾›ã•ã‚Œã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå…·ä½“ä¾‹ã¨è§£èª¬ï¼‰ã€‘
${interpretationText || 'è©²å½“ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“'}

ã€å›ç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
å¿…ãšä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¾“ã£ã¦å›ç­”ã—ã¦ãã ã•ã„ï¼š

## è³ªå•ã®è§£é‡ˆ
[AIãŒç†è§£ã—ãŸè³ªå•ã®æ„å›³ã‚’1-2æ–‡ã§æ˜ç¢ºã«è¨˜è¿°]

## å›ç­”
[ç«¶æŠ€è¦å‰‡ã«åŸºã¥ãæ˜ç¢ºã§ç°¡æ½”ãªå›ç­”ï¼ˆ2-4æ–‡ç¨‹åº¦ï¼‰]

## æ ¹æ‹ 

### 1. ç«¶æŠ€è¦å‰‡
**ç¬¬â—‹æ¡ [æ¡æ–‡å]**
> [åŸæ–‡ã®é‡è¦éƒ¨åˆ†ã‚’å¼•ç”¨]

ï¼ˆè©²å½“ã™ã‚‹ç«¶æŠ€è¦å‰‡æœ¬æ–‡ãŒã‚ã‚‹å ´åˆã®ã¿è¨˜è¼‰ï¼‰

### 2. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
**ç¬¬â—‹æ¡ [æ¡æ–‡å] â—‹-â—‹**
> [åŸæ–‡ã®é‡è¦éƒ¨åˆ†ã‚’å¼•ç”¨]

[å…·ä½“ä¾‹ã®èª¬æ˜ãŒã‚ã‚Œã°ç°¡æ½”ã«è¨˜è¼‰]

ï¼ˆè©²å½“ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã®ã¿è¨˜è¼‰ï¼‰

## è£œè¶³èª¬æ˜
[å¿…è¦ã«å¿œã˜ã¦ã€è¤‡æ•°ã®æ¡æ–‡ã‚’çµ±åˆã—ãŸèª¬æ˜ã‚„æ³¨æ„ç‚¹ã‚’è¨˜è¼‰]

## é–¢é€£ã™ã‚‹è³ªå•å€™è£œ
ã“ã®è³ªå•ã«é–¢é€£ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè³ªå•ã®æ„å›³ã‚‚ã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼š
1. [å…·ä½“çš„ãªçŠ¶æ³ã‚’è¿½åŠ ã—ãŸè³ªå•]
2. [ä¾‹å¤–ã‚±ãƒ¼ã‚¹ã«é–¢ã™ã‚‹è³ªå•]
3. [é–¢é€£ã™ã‚‹åˆ¥ã®ãƒ«ãƒ¼ãƒ«ã«é–¢ã™ã‚‹è³ªå•]

ã€å›ç­”ä¾‹1ï¼šã‚·ãƒ§ãƒƒãƒˆã‚¯ãƒ­ãƒƒã‚¯ã®è³ªå•ã€‘

è³ªå•ï¼šã€Œã‚·ãƒ§ãƒƒãƒˆã‚¯ãƒ­ãƒƒã‚¯æ®‹ã‚Š18ç§’ã®ã¨ãã«ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚³ãƒ¼ãƒˆã§ãƒ˜ãƒ«ãƒ‰ãƒœãƒ¼ãƒ«ã€ã‚ªãƒ•ã‚§ãƒ³ã‚¹ç¶™ç¶šã€‚ã‚·ãƒ§ãƒƒãƒˆã‚¯ãƒ­ãƒƒã‚¯ã¯ï¼Ÿã€

## è³ªå•ã®è§£é‡ˆ
ãƒœãƒ¼ãƒ«ãƒã‚¼ãƒƒã‚·ãƒ§ãƒ³ãŒå¤‰ã‚ã‚‰ãšã€ã‚ªãƒ•ã‚§ãƒ³ã‚¹ãŒç¶™ç¶šã™ã‚‹å ´åˆã®ã‚·ãƒ§ãƒƒãƒˆã‚¯ãƒ­ãƒƒã‚¯æ“ä½œã«ã¤ã„ã¦ç¢ºèªã—ãŸã„è³ªå•ã§ã™ã€‚

## å›ç­”
ã‚·ãƒ§ãƒƒãƒˆã‚¯ãƒ­ãƒƒã‚¯ã¯18ç§’ã®ã¾ã¾ç¶™ç¶šã—ã¾ã™ã€‚ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã›ã‚“ã€‚

## æ ¹æ‹ 

### 1. ç«¶æŠ€è¦å‰‡
**ç¬¬29æ¡ ã‚·ãƒ§ãƒƒãƒˆã‚¯ãƒ­ãƒƒã‚¯**
> ã‚·ãƒ§ãƒƒãƒˆã‚¯ãƒ­ãƒƒã‚¯ã¯ãƒœãƒ¼ãƒ«ãŒãƒ©ã‚¤ãƒ–ã«ãªã£ãŸã¨ãã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹ã€‚

### 2. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
**ç¬¬29/50æ¡ ã‚·ãƒ§ãƒƒãƒˆã‚¯ãƒ­ãƒƒã‚¯ 29-2**
> ãƒ˜ãƒ«ãƒ‰ãƒœãƒ¼ãƒ«ã§ã‚ªãƒ«ã‚¿ãƒã‚¤ãƒ†ã‚£ãƒ³ã‚°ãƒã‚¼ãƒƒã‚·ãƒ§ãƒ³ã‚¢ãƒ­ãƒ¼ãŒãƒœãƒ¼ãƒ«ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã—ã¦ã„ãŸãƒãƒ¼ãƒ ã‚’ç¤ºã—ã¦ã„ã‚‹å ´åˆã€ã‚·ãƒ§ãƒƒãƒˆã‚¯ãƒ­ãƒƒã‚¯ã¯ç¶™ç¶šã™ã‚‹ã€‚

ã€Œã‚ªãƒ•ã‚§ãƒ³ã‚¹ç¶™ç¶šã€ã®å ´åˆã€ãƒœãƒ¼ãƒ«ãƒã‚¼ãƒƒã‚·ãƒ§ãƒ³ã¯å¤‰ã‚ã£ã¦ã„ãªã„ãŸã‚ã€14ç§’ãƒªã‚»ãƒƒãƒˆã®æ¡ä»¶ã‚’æº€ãŸã—ã¾ã›ã‚“ã€‚

## è£œè¶³èª¬æ˜
14ç§’ãƒªã‚»ãƒƒãƒˆãŒé©ç”¨ã•ã‚Œã‚‹ã®ã¯ã€Œãƒœãƒ¼ãƒ«ãƒã‚¼ãƒƒã‚·ãƒ§ãƒ³ãŒå¤‰ã‚ã‚‹ã€å ´åˆã®ã¿ã§ã™ã€‚ãƒ˜ãƒ«ãƒ‰ãƒœãƒ¼ãƒ«ã§ã‚‚ãƒã‚¼ãƒƒã‚·ãƒ§ãƒ³ãŒå¤‰ã‚ã‚‰ãªã„å ´åˆã¯ã€ã‚·ãƒ§ãƒƒãƒˆã‚¯ãƒ­ãƒƒã‚¯ã¯æ­¢ã¾ã‚‰ãšã€ãã®ã¾ã¾ç¶™ç¶šã—ã¾ã™ã€‚

## é–¢é€£ã™ã‚‹è³ªå•å€™è£œ
ã“ã®è³ªå•ã«é–¢é€£ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè³ªå•ã®æ„å›³ã‚‚ã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼š
1. ã‚·ãƒ§ãƒƒãƒˆã‚¯ãƒ­ãƒƒã‚¯æ®‹ã‚Š18ç§’ã®ã¨ãã«ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚³ãƒ¼ãƒˆã§ãƒ˜ãƒ«ãƒ‰ãƒœãƒ¼ãƒ«ã€ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ã«ãƒœãƒ¼ãƒ«ãŒæ¸¡ã£ãŸå ´åˆã€ã‚·ãƒ§ãƒƒãƒˆã‚¯ãƒ­ãƒƒã‚¯ã¯ï¼Ÿ
2. ã‚·ãƒ§ãƒƒãƒˆã‚¯ãƒ­ãƒƒã‚¯æ®‹ã‚Š10ç§’ã§ãƒ˜ãƒ«ãƒ‰ãƒœãƒ¼ãƒ«ã€ã‚ªãƒ•ã‚§ãƒ³ã‚¹ç¶™ç¶šã®å ´åˆã¯ï¼Ÿ
3. ãƒ˜ãƒ«ãƒ‰ãƒœãƒ¼ãƒ«ã§ã‚ªãƒ«ã‚¿ãƒã‚¤ãƒ†ã‚£ãƒ³ã‚°ãƒã‚¼ãƒƒã‚·ãƒ§ãƒ³ãŒé©ç”¨ã•ã‚Œã‚‹æ¡ä»¶ã¯ï¼Ÿ

---

ã€å›ç­”ä¾‹2ï¼šã‚¢ãƒ³ã‚¹ãƒãƒ¼ãƒ„ãƒãƒ³ãƒ©ã‚¤ã‚¯ãƒ•ã‚¡ã‚¦ãƒ«ã®è³ªå•ã€‘

è³ªå•ï¼šã€Œã‚¢ãƒ³ã‚¹ãƒãƒ¼ãƒ„ãƒãƒ³ãƒ©ã‚¤ã‚¯ãƒ•ã‚¡ã‚¦ãƒ«ãŒç™ºç”Ÿã—ãŸå ´åˆã®å…·ä½“çš„ãªçŠ¶æ³ã¯ï¼Ÿã€

## è³ªå•ã®è§£é‡ˆ
ã‚¢ãƒ³ã‚¹ãƒãƒ¼ãƒ„ãƒãƒ³ãƒ©ã‚¤ã‚¯ãƒ•ã‚¡ã‚¦ãƒ«ã¨ã—ã¦åˆ¤å®šã•ã‚Œã‚‹å…·ä½“çš„ãªã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çŸ¥ã‚ŠãŸã„è³ªå•ã§ã™ã€‚

## å›ç­”
ã‚¢ãƒ³ã‚¹ãƒãƒ¼ãƒ„ãƒãƒ³ãƒ©ã‚¤ã‚¯ãƒ•ã‚¡ã‚¦ãƒ«ã¯ã€æ­£å½“ãªãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ã¨ã¯èªã‚ã‚‰ã‚Œãªã„ä¸å¿…è¦ãªæ¥è§¦ã‚„ã€éåº¦ã«æ¿€ã—ã„æ¥è§¦ãŒã‚ã£ãŸå ´åˆã«åˆ¤å®šã•ã‚Œã¾ã™ã€‚

## æ ¹æ‹ 

### 1. ç«¶æŠ€è¦å‰‡
**ç¬¬37æ¡ ã‚¢ãƒ³ã‚¹ãƒãƒ¼ãƒ„ãƒãƒ³ãƒ©ã‚¤ã‚¯ãƒ•ã‚¡ã‚¦ãƒ«**
> ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ãŒãƒœãƒ¼ãƒ«ã«å¯¾ã—ã¦æ­£å½“ã«ãƒ—ãƒ¬ãƒ¼ã—ã‚ˆã†ã¨ã™ã‚‹åŠªåŠ›ã‚’ã—ãªã„ã§ç›¸æ‰‹ãƒãƒ¼ãƒ ã®ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã«å¯¾ã—ã¦èµ·ã“ã—ãŸã‚³ãƒ³ã‚¿ã‚¯ãƒˆã¯ã‚¢ãƒ³ã‚¹ãƒãƒ¼ãƒ„ãƒãƒ³ãƒ©ã‚¤ã‚¯ãƒ•ã‚¡ã‚¦ãƒ«ã§ã‚ã‚‹ã€‚

### 2. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
**ç¬¬37æ¡ ã‚¢ãƒ³ã‚¹ãƒãƒ¼ãƒ„ãƒãƒ³ãƒ©ã‚¤ã‚¯ãƒ•ã‚¡ã‚¦ãƒ« 37-1**
> é€Ÿæ”»ã®çŠ¶æ³ã§ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ã®ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ãŒãƒœãƒ¼ãƒ«ã«å¯¾ã™ã‚‹æ­£å½“ãªãƒ—ãƒ¬ãƒ¼ã‚’ã›ãšãƒ•ã‚¡ã‚¦ãƒ«ã‚’ã—ãŸå ´åˆã€ã‚¢ãƒ³ã‚¹ãƒãƒ¼ãƒ„ãƒãƒ³ãƒ©ã‚¤ã‚¯ãƒ•ã‚¡ã‚¦ãƒ«ã¨ãªã‚‹ã€‚

å…·ä½“ä¾‹ï¼šé€Ÿæ”»ä¸­ã®ã‚ªãƒ•ã‚§ãƒ³ã‚¹ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã«å¯¾ã—ã¦ã€ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ãŒãƒœãƒ¼ãƒ«ã§ã¯ãªãä½“ã‚’æŠ¼ã•ãˆã¦ãƒ•ã‚¡ã‚¦ãƒ«ã—ãŸå ´åˆãªã©ã€‚

## è£œè¶³èª¬æ˜
ã‚¢ãƒ³ã‚¹ãƒãƒ¼ãƒ„ãƒãƒ³ãƒ©ã‚¤ã‚¯ãƒ•ã‚¡ã‚¦ãƒ«ã¯é€šå¸¸ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ•ã‚¡ã‚¦ãƒ«ã‚ˆã‚Šã‚‚é‡ã„ç½°å‰‡ãŒã‚ã‚Šã€2æœ¬ã¾ãŸã¯3æœ¬ã®ãƒ•ãƒªãƒ¼ã‚¹ãƒ­ãƒ¼ã¨ã‚¹ãƒ­ãƒ¼ã‚¤ãƒ³ãŒä¸ãˆã‚‰ã‚Œã¾ã™ã€‚

## é–¢é€£ã™ã‚‹è³ªå•å€™è£œ
ã“ã®è³ªå•ã«é–¢é€£ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè³ªå•ã®æ„å›³ã‚‚ã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼š
1. ã‚¢ãƒ³ã‚¹ãƒãƒ¼ãƒ„ãƒãƒ³ãƒ©ã‚¤ã‚¯ãƒ•ã‚¡ã‚¦ãƒ«ã¨ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ãƒ•ã‚¡ã‚¦ãƒ«ã®é•ã„ã¯ï¼Ÿ
2. ã‚¢ãƒ³ã‚¹ãƒãƒ¼ãƒ„ãƒãƒ³ãƒ©ã‚¤ã‚¯ãƒ•ã‚¡ã‚¦ãƒ«ã®ç½°å‰‡ã¯ï¼Ÿ
3. ã©ã®ã‚ˆã†ãªå ´åˆã«ãƒ‡ã‚£ã‚¹ã‚¯ã‚©ãƒªãƒ•ã‚¡ã‚¤ãƒ³ã‚°ãƒ•ã‚¡ã‚¦ãƒ«ã«ãªã‚‹ã®ã‹ï¼Ÿ`
        },
        {
          role: 'user',
          content: normalizedQuestion
        }
      ],
      temperature: 0.1,
      max_tokens: 2500,
    });

    const answerText = completion.choices[0]?.message?.content || '';
    console.log('âœ… å›ç­”ç”Ÿæˆå®Œäº†\n');

    // é–¢é€£è³ªå•ã‚’æŠ½å‡º
    const relatedQuestionsMatch = answerText.match(/## é–¢é€£ã™ã‚‹è³ªå•å€™è£œ\n([\s\S]*?)(?=\n##|\n$|$)/);
    let relatedQuestions: string[] = [];
    let mainAnswer = answerText;

    if (relatedQuestionsMatch) {
      const relatedSection = relatedQuestionsMatch[1];
      relatedQuestions = relatedSection
        .split('\n')
        .filter(line => /^\d+\./.test(line.trim()))
        .map(line => line.replace(/^\d+\.\s*/, '').trim())
        .filter(q => q.length > 0);
      
      mainAnswer = answerText.replace(/## é–¢é€£ã™ã‚‹è³ªå•å€™è£œ[\s\S]*$/, '').trim();
      
      console.log('ğŸ’¡ é–¢é€£è³ªå•:', relatedQuestions.length, 'ä»¶');
    }

    // HTMLã«å¤‰æ›ï¼ˆæ”¹å–„ã•ã‚ŒãŸã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ï¼‰
    const htmlAnswer = mainAnswer
      .replace(/## è³ªå•ã®è§£é‡ˆ\n/g, '<div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded"><h2 class="text-lg font-bold text-blue-900 mb-2">ğŸ“Œ è³ªå•ã®è§£é‡ˆ</h2><p class="text-blue-800">')
      .replace(/\n## å›ç­”\n/g, '</p></div><div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6 rounded"><h2 class="text-lg font-bold text-green-900 mb-2">âœ… å›ç­”</h2><p class="text-green-800 font-semibold text-lg">')
      .replace(/\n## æ ¹æ‹ \n/g, '</p></div><div class="bg-gray-50 border-l-4 border-gray-500 p-4 mb-6 rounded"><h2 class="text-lg font-bold text-gray-900 mb-3">ğŸ“– æ ¹æ‹ </h2>')
      .replace(/### 1\. ç«¶æŠ€è¦å‰‡\n/g, '<h3 class="text-md font-bold text-gray-800 mt-4 mb-2">ã€1. ç«¶æŠ€è¦å‰‡ã€‘</h3>')
      .replace(/### 2\. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³\n/g, '<h3 class="text-md font-bold text-gray-800 mt-4 mb-2">ã€2. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€‘</h3>')
      .replace(/\n## è£œè¶³èª¬æ˜\n/g, '</div><div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6 rounded"><h2 class="text-lg font-bold text-yellow-900 mb-2">ğŸ’¡ è£œè¶³èª¬æ˜</h2><p class="text-yellow-800">')
      .replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold text-gray-900">$1</strong>')
      .replace(/^> (.+)/gm, '<blockquote class="border-l-4 border-orange-400 pl-4 py-2 my-2 bg-orange-50 text-gray-700">$1</blockquote>')
      .replace(/\n\n/g, '</p><p class="mb-2 text-gray-700">')
      .replace(/$/, '</p></div>');

    const responseTime = Date.now() - startTime;

    // ãƒ­ã‚°ä¿å­˜
    try {
      const supabase = createClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
      );

      await supabase.from('query_logs').insert({
        question,
        normalized_question: normalizedQuestion,
        ai_answer: htmlAnswer,
        raw_answer: answerText,
        rag_results: ragResults,
        rag_count: ragResults.length,
        response_time_ms: responseTime,
        user_agent: request.headers.get('user-agent'),
        ip_address: request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip'),
        referrer: request.headers.get('referer'),
        model_used: 'gpt-4o-mini'
      });

      console.log('ğŸ“Š ãƒ­ã‚°ä¿å­˜å®Œäº†');
    } catch (logError) {
      console.error('âš ï¸ ãƒ­ã‚°ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼ˆå‡¦ç†ã¯ç¶™ç¶šï¼‰:', logError);
    }

    return NextResponse.json({ 
      answer: htmlAnswer,
      rawAnswer: answerText,
      relatedQuestions,
      signalImages: signalImages.map(img => ({
        name: img.name,
        path: img.path,
        description: img.description
      })),
      model: 'gpt-4o-mini (RAG)',
      originalQuestion: question,
      normalizedQuestion: normalizedQuestion,
      ragResults: ragResults.map(r => ({
        sectionId: r.sectionId,
        sectionName: r.sectionName,
        similarity: r.similarity
      }))
    });

  } catch (error: any) {
    console.error('âŒ è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±:', error);
    
    if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
      return NextResponse.json(
        { error: 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚' },
        { status: 500 }
      );
    } else if (error.message.includes('Supabase') || error.message.includes('Database')) {
      return NextResponse.json(
        { error: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚' },
        { status: 500 }
      );
    } else if (error.message.includes('OpenAI') || error.message.includes('API')) {
      return NextResponse.json(
        { error: 'AI APIã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚' },
        { status: 500 }
      );
    } else {
      return NextResponse.json(
        { error: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚ã‚¨ãƒ©ãƒ¼ãŒç¶šãå ´åˆã¯ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚' },
        { status: 500 }
      );
    }
  }
}